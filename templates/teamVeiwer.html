{% include 'head.html' %}

<body style="background-color: #222">
    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <div class="container" style="margin-top: 30px; z-index:2; position:absolute; margin-left: auto; margin-right: auto; left: 0; right: 0;">
        {% for message in messages %}
        <div class="alert alert-dismissible alert-success fade in" id="alert">
            <button type="button" class="close" data-dismiss="alert">&times;</button>
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    {% include 'nav.html' %}

        <div class="container" style="margin-top: 30px">
<div class="card">
  <div class="card-body overflow-auto">
<div class="btn-group btn-group-toggle" data-toggle="buttons">
  <label class="btn btn-secondary active" >
    <input type="checkbox" onchange="changeChartVisiblity(0)" checked> Total Points
  </label>
  <label class="btn btn-secondary active">
    <input type="checkbox" onchange="changeChartVisiblity(1)" checked> Teleop Points
  </label>
    <label class="btn btn-secondary active">
    <input type="checkbox" onchange="changeChartVisiblity(2)" checked> Auto Points
  </label>
  <label class="btn btn-secondary">
    <input type="checkbox" onchange="changeChartVisiblity(3)"> Cargo Points
  </label>
    <label class="btn btn-secondary">
    <input type="checkbox" onchange="changeChartVisiblity(4)"> Climb Points
  </label>
    <label class="btn btn-secondary">
    <input type="checkbox" onchange="changeChartVisiblity(5)"> Hatch Panel Points
  </label>
    <label class="btn btn-secondary">
    <input type="checkbox" onchange="changeChartVisiblity(6)"> Foul Points
  </label>
</div>
      <hr>

        <div id="chartContainer" style="height: 300px; width: 100%;"></div>
        </div>
</div>
        </div>
</body>
<script src="https://canvasjs.com/assets/script/jquery.canvasjs.min.js"></script>
<script type="text/javascript">
    var team = "{{ team }}"
    var year = "2019"
    var matchDataPoints = {
        "totalPoints": [],
        "teleopPoints": [],
        "autoPoints": [],
        "cargoPoints": [],
        "habClimbPoints": [],
        "hatchPanelPoints": [],
        "foulPoints": [],
     };

    var matchChartOptions = {
            animationEnabled: false,
            theme: "dark2",
            title:{
                text: "Team " + team.replace("frc", "") + " | Match Data"
            },
            axisX:{
                valueFormatString: "DD MMM",
                scaleBreaks: {
                    autoCalculate: true //change it to false
                }
            },
            axisY: {
                title: "Points",
                suffix: "",
                minimum: -10
            },
            toolTip:{
                shared:true
            },
            legend:{
                cursor:"pointer",
                verticalAlign: "bottom",
                horizontalAlign: "left",
                dockInsidePlotArea: true,

            },
            data: []
        };
    for (point in matchDataPoints) {
        matchChartOptions["data"].push({
            visible: false,
            type: "line",
            showInLegend: true,
            name: point,
            xValueFormatString: "DD MMM, YYYY",
            yValueFormatString: "#",
            dataPoints: matchDataPoints[point]
        });
    }
    var matchChart = new CanvasJS.Chart("chartContainer", matchChartOptions);

 $.ajax({
     url: "https://www.thebluealliance.com/api/v3/team/" + team + "/events/" + year,
     headers: {"X-TBA-Auth-Key":"1P043y5bGx3Rw0izZO20VjyIfU9A0e9bzdpoDzjY8wHah294RGmA7hnk2WGA1N6M"},
     success: function (events) {
         for (event in events) {


             $.ajax({
                 url: "https://www.thebluealliance.com/api/v3/team/" + team + "/event/" + events[event]["key"] + "/matches",
                 headers: {"X-TBA-Auth-Key": "1P043y5bGx3Rw0izZO20VjyIfU9A0e9bzdpoDzjY8wHah294RGmA7hnk2WGA1N6M"},
                 success: function (matches) {


                     for (match in matches) {
                         var actualTime = matches[match]["actual_time"] * 1000
                         if (matches[match]["alliances"]["blue"]["team_keys"].includes(team)) {
                             scores = matches[match]["score_breakdown"]["blue"]
                             var robotIndex = matches[match]["alliances"]["blue"]["team_keys"].indexOf(team) + 1
                         } else {
                             scores = matches[match]["score_breakdown"]["red"]
                             var robotIndex = matches[match]["alliances"]["red"]["team_keys"].indexOf(team) + 1
                         }
                         matchDataPoints["totalPoints"].push({x: new Date(actualTime), y: scores["totalPoints"]});
                         matchDataPoints["teleopPoints"].push({x: new Date(actualTime), y: scores["teleopPoints"]});
                         matchDataPoints["autoPoints"].push({x: new Date(actualTime), y: scores["autoPoints"]});
                         matchDataPoints["cargoPoints"].push({x: new Date(actualTime), y: scores["cargoPoints"]});
                         matchDataPoints["habClimbPoints"].push({x: new Date(actualTime), y: scores["habClimbPoints"]});
                         matchDataPoints["hatchPanelPoints"].push({x: new Date(actualTime), y: scores["hatchPanelPoints"]});
                         matchDataPoints["foulPoints"].push({x: new Date(actualTime), y: scores["foulPoints"]});
                     }

                     for (value in matchDataPoints) {
                         matchDataPoints[value].sort(function (a, b) {
                             a = new Date(a.x);
                             b = new Date(b.x);
                             return a > b ? -1 : a < b ? 1 : 0;
                         });
                         matchDataPoints[value].sort();
                         matchChart.options.data[0].visible = true;
                         matchChart.options.data[1].visible = true;
                         matchChart.options.data[2].visible = true;
                         matchChart.render();


                     }

                 }
             });

         }


         matchChart.render();

     }
 });

function changeChartVisiblity(i) {
    matchChart.options.data[i].visible = !matchChart.options.data[i].visible;
    matchChart.render();
}

        $("#alert").fadeTo(5000, 500).slideUp(500, function(){
        $("#alert").slideUp(500);
    });

</script>